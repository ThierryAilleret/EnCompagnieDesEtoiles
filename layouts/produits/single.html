{{ define "main" }}
  <article>
    <h1>{{ .Title }}</h1>
    <h4>{{ .Params.description }}</h4>

    <!-- Galerie d‚Äôimages avec fl√®ches -->
    <div class="gallery-container">
      <button id="left-scroll" class="scroll-button arrow"
              onclick="scrollGallery(-1)" aria-label="D√©filer vers la gauche">
        <svg width="24" height="40" viewBox="0 0 24 40">
          <polyline points="20,4 4,20 20,36"
                    fill="none" stroke="#888" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>

      <div class="gallery">
        {{ if .Params.thumbnail }}
          <img src="{{ .Params.thumbnail }}" alt="{{ .Params.thumbnail_alt }}"
               onclick="openModal('{{ .Params.thumbnail }}','{{ .Params.thumbnail_alt }}')">
        {{ end }}
				{{ range .Params.images }}
					<img src="{{ . }}" alt=""
							 onclick="openModal('{{ . }}','')">
				{{ end }}

      </div>

      <button id="right-scroll" class="scroll-button arrow"
              onclick="scrollGallery(1)" aria-label="D√©filer vers la droite">
        <svg width="24" height="40" viewBox="0 0 24 40">
          <polyline points="4,4 20,20 4,36"
                    fill="none" stroke="#888" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>

    <div class="fiche-texte">
      <p>{{ .Params.description_longue | safeHTML }}</p>
      <ul>
        <li><strong>Dimensions :</strong> {{ .Params.dimensions | safeHTML }}</li>
        <li><strong>Mat√©riaux :</strong> {{ .Params.materiaux | safeHTML }}</li>
        <li><strong>Ampoule :</strong> {{ .Params.ampoule | safeHTML }}</li>
        <li><strong>Normes :</strong> <img src="/images/CE.png" alt="Logo CE" class="img-icon"></li>
        <li><strong>Fabriqu√© √† :</strong> Dunkerque, France</li>
      </ul>
    </div>

    <p>Prix : {{ .Params.price }} {{ .Params.currency }}</p>
		<button class="btn-add-to-cart" onclick="ajouterAuPanier()">Ajouter au panier</button>
  </article>

  <!-- Modal plein √©cran -->
  <div id="imageModal" class="modal" onclick="closeModal()">
    <div class="modal-content-wrapper" onclick="event.stopPropagation()">
      <span class="close" onclick="closeModal()" aria-label="Fermer">&times;</span>

      <div class="modal-body">
        <button class="nav-button left-nav"
                onclick="navigateImage(-1)" aria-label="Image pr√©c√©dente">&#10094;</button>
        <img id="modalImage" class="modal-content" alt="">
        <button class="nav-button right-nav"
                onclick="navigateImage(1)" aria-label="Image suivante">&#10095;</button>
      </div>

      <div id="modalCaption" class="caption"></div>
    </div>
  </div>



  <!-- Script -->
  <script>
    let currentImageIndex = 0;
    let images = [];

    function collectGalleryImages() {
      return Array.from(document.querySelectorAll('.gallery img'))
        .map(img => ({ src: img.src, alt: img.alt }));
    }

    function getFilename(url) {
      return new URL(url, window.location.origin).pathname;
    }

    function scrollGallery(direction) {
      const gallery = document.querySelector('.gallery');
      const moveBy = gallery.clientWidth * 0.8;
      gallery.scrollBy({ left: direction * moveBy, behavior: 'smooth' });
    }

    function checkScrollPosition() {
      const g = document.querySelector('.gallery');
      document.getElementById('left-scroll').style.visibility =
        g.scrollLeft <= 5 ? 'hidden' : 'visible';
      document.getElementById('right-scroll').style.visibility =
        g.scrollLeft + g.clientWidth >= g.scrollWidth - 5 ? 'hidden' : 'visible';
    }

		window.addEventListener('load', () => {
			// Galerie + scroll
			const gallery = document.querySelector('.gallery');
			gallery.addEventListener('scroll', checkScrollPosition);
			setTimeout(checkScrollPosition, 100);
			images = collectGalleryImages();

			// Panier visuel
			mettreAJourIndicateur();
		});

    function openModal(src, alt) {
      images = collectGalleryImages();
      currentImageIndex = images.findIndex(img =>
        getFilename(img.src) === getFilename(src)
      );
      if (currentImageIndex < 0) currentImageIndex = 0;

      const imgEl = document.getElementById('modalImage');
      const cap   = document.getElementById('modalCaption');
      imgEl.src = src;
      imgEl.alt = alt;
      cap.textContent = alt;
      imgEl.style.transform = 'translateX(0)';

      const modal = document.getElementById('imageModal');
      modal.style.display = 'flex';
      setTimeout(() => modal.classList.add('show'), 10);
    }

    function closeModal() {
      const modal = document.getElementById('imageModal');
      modal.classList.remove('show');
      setTimeout(() => modal.style.display = 'none', 300);
    }

		function navigateImage(direction) {
			if (!images.length || currentImageIndex < 0) return;

			const imgEl = document.getElementById('modalImage');
			const cap   = document.getElementById('modalCaption');

			// calcul des positions de sortie et d‚Äôentr√©e
			const outX = direction > 0 ? '-100%' : '100%';
			const inX  = direction > 0 ? '100%'  : '-100%';

			// slide out
			imgEl.style.transition = 'transform 0.3s ease';
			imgEl.style.transform  = `translateX(${outX})`;

			setTimeout(() => {
				// mise √† jour de l‚Äôindex
				currentImageIndex = (currentImageIndex + direction + images.length) % images.length;

				// pr√©paration de l‚Äôimage entrante hors champ
				imgEl.style.transition = 'none';
				imgEl.style.transform  = `translateX(${inX})`;
				imgEl.src   = images[currentImageIndex].src;
				imgEl.alt   = images[currentImageIndex].alt;
				cap.textContent = images[currentImageIndex].alt;

				// forcer le reflow pour que la transition soit prise en compte
				void imgEl.offsetWidth;

				// slide in
				imgEl.style.transition = 'transform 0.3s ease';
				imgEl.style.transform  = 'translateX(0)';
			}, 300);
		}
		
		function ajouterAuPanier() {
			const panier = JSON.parse(localStorage.getItem("panier")) || [];

			const titre = document.querySelector("h1").textContent.trim();
			const description = document.querySelector("h4").textContent.trim();
			const prix = parseFloat("{{ .Params.price }}");
			const monnaie = "{{ .Params.currency }}";
			const image = "{{ .Params.thumbnail }}".startsWith("http")
				? "{{ .Params.thumbnail }}"
				: `https://encompagniedesetoiles.fr{{ .Params.thumbnail }}`;

			// üîç V√©rification avant ajout
			if (isNaN(prix) || !monnaie || !titre) {
				console.error("Article invalide ‚Äì v√©rifie les donn√©es !");
				alert("‚ö†Ô∏è Impossible d'ajouter cet article : donn√©es manquantes ou invalides.");
				return;
			}

			const index = panier.findIndex(p => p.titre === titre);

			if (index >= 0) {
				panier[index].quantite += 1;
			} else {
				panier.push({
					titre,
					description,
					prix,
					monnaie,
					image,
					quantite: 1
				});
			}

			localStorage.setItem("panier", JSON.stringify(panier));
			mettreAJourIndicateur();

			// üõí Ouvre le volet si ferm√© et d√©place le logo
			const volet = document.getElementById("mini-panier");
			const indicateur = document.getElementById("panier-toggle");

			if (!volet.classList.contains("actif")) {
				volet.classList.add("actif", "slide-in");
				setTimeout(() => volet.classList.remove("slide-in"), 300);
			}

			if (indicateur) {
				indicateur.classList.add("panier-decale"); // üëà d√©place le logo üõí
				indicateur.classList.add("pulse");
				setTimeout(() => indicateur.classList.remove("pulse"), 300);
			}

			afficherMiniPanier();
		}


		


  </script>

  <!-- CSS optimis√© -->
  <style>
    /* Galerie sans barre de scroll visible */
    .gallery {
      display: flex;
      overflow-x: auto;
      overflow-y: hidden;
      gap: 10px;
      padding: 10px 0;
      scroll-behavior: smooth;
      scroll-snap-type: x mandatory;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    .gallery::-webkit-scrollbar { display: none; }

    .gallery img {
      height: 300px;
      cursor: pointer;
      border: 1px solid #ddd;
      scroll-snap-align: center;
      transition: transform 0.2s;
    }
    .gallery img:hover { transform: scale(1.05); }

    .gallery-container {
      display: grid;
      grid-template-columns: 50px 1fr 50px;
      align-items: center;
      gap: 10px;
      margin: 20px 0;
    }
    .scroll-button {
      background: none;
      border: none;
      padding: 5px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .scroll-button:hover { background-color: #eee; }

    .fiche-texte ul {
      list-style: none;
      padding: 0;
      margin: 1em 0;
    }
    .fiche-texte li { margin-bottom: 0.5em; }
    .img-icon { height: 12px; margin-left: 5px; vertical-align: middle; }

    .btn-add-to-cart {
      background: #007acc;
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .btn-add-to-cart:hover { background: #005fa3; }

    /* Modal overlay + fond gris translucide */
    .modal {
			backdrop-filter: blur(2px);
			-webkit-backdrop-filter: blur(2px);
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 1000;
    }
    .modal.show { opacity: 1; }

    /* Suppression du fond noir, on laisse transparent */
    .modal-content-wrapper {
      position: relative;
      max-width: 80%;
      max-height: 80%;
      display: flex;
      flex-direction: column;
      align-items: center;
      overflow: hidden;
      background: transparent;
    }

    .modal-body {
      position: relative;
      width: 100%;
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      max-height: calc(80vh - 40px);
      width: auto;
      object-fit: contain;
      transform: translateX(0);
    }

    .close {
      position: absolute;
      top: 10px;
      right: 10px;
      color: #fff;
      font-size: 35px;
      cursor: pointer;
      transition: color 0.3s;
      z-index: 10;
    }
    .close:hover { color: #bbb; }

    .nav-button {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(0,0,0,0.5);
      color: #fff;
      border: none;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      border-radius: 50%;
      cursor: pointer;
      transition: background 0.3s;
      z-index: 10;
    }
    .nav-button:hover { background: rgba(0,0,0,0.7); }
    .left-nav  { left: 20px; }
    .right-nav { right: 20px; }

    .caption {
      color: #ccc;
      padding: 8px 0;
      text-align: center;
      font-size: 20px;
      width: 100%;
    }


  </style>
{{ end }}
