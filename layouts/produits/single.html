{{ define "main" }}
	<div class="single-container">
		<article>
		
			<h1>{{ .Title }}</h1>
			<h3>{{ .Params.description }}</h3>

			<!-- Galerie d‚Äôimages avec fl√®ches -->
			<div class="gallery-container">
				<button id="left-scroll" class="scroll-button arrow"
								onclick="scrollGallery(-1)" aria-label="D√©filer vers la gauche">
					<svg width="24" height="40" viewBox="0 0 24 40">
						<polyline points="20,4 4,20 20,36"
											fill="none" stroke="#888" stroke-width="2"
											stroke-linecap="round" stroke-linejoin="round"/>
					</svg>
				</button>

				<div class="gallery">
					{{ if .Params.thumbnail }}
						<img src="{{ .Params.thumbnail }}" alt="{{ .Params.thumbnail_alt }}"
								 onclick="openModal('{{ .Params.thumbnail }}','{{ .Params.thumbnail_alt }}')">
					{{ end }}
					{{ range .Params.images }}
						<img src="{{ . }}" alt=""
								 onclick="openModal('{{ . }}','')">
					{{ end }}

				</div>

				<button id="right-scroll" class="scroll-button arrow"
								onclick="scrollGallery(1)" aria-label="D√©filer vers la droite">
					<svg width="24" height="40" viewBox="0 0 24 40">
						<polyline points="4,4 20,20 4,36"
											fill="none" stroke="#888" stroke-width="2"
											stroke-linecap="round" stroke-linejoin="round"/>
					</svg>
				</button>
			</div>

			<div class="fiche-texte">
				<p>{{ .Params.description_longue | safeHTML }}</p>
				<ul>
					<li><strong>Dimensions :</strong> {{ .Params.dimensions | safeHTML }}</li>
					<li><strong>Mat√©riaux :</strong> {{ .Params.materiaux | safeHTML }}</li>
					<li><strong>Ampoule :</strong> {{ .Params.ampoule | safeHTML }}</li>
					<li><strong>Normes :</strong> <img src="/images/CE.png" alt="Logo CE" class="img-icon"></li>
					<li><strong>Fabriqu√© √† :</strong> Dunkerque, France</li>
				</ul>
			</div>
			<p>Stock disponible : <span id="stock-display">Chargement...</span></p>
			<p>Prix : {{ .Params.price }} {{ .Params.currency }}</p>
			<button class="btn-add-to-cart" onclick="ajouterAuPanier()">Ajouter au panier</button>
		</article>
	</div>

  <!-- Modal plein √©cran -->
  <div id="imageModal" class="modal" onclick="closeModal()">
    <div class="modal-content-wrapper" onclick="event.stopPropagation()">
      <span class="close" onclick="closeModal()" aria-label="Fermer">&times;</span>

      <div class="modal-body">
        <button class="nav-button left-nav"
                onclick="navigateImage(-1)" aria-label="Image pr√©c√©dente">&#10094;</button>
        <img id="modalImage" class="modal-content" alt="">
        <button class="nav-button right-nav"
                onclick="navigateImage(1)" aria-label="Image suivante">&#10095;</button>
      </div>

      <div id="modalCaption" class="caption"></div>
    </div>
  </div>



  <!-- Script -->
  <script>
    let stockDisponible = 0;
		let currentImageIndex = 0;
    let images = [];

    function collectGalleryImages() {
      return Array.from(document.querySelectorAll('.gallery img'))
        .map(img => ({ src: img.src, alt: img.alt }));
    }

    function getFilename(url) {
      return new URL(url, window.location.origin).pathname;
    }

    function scrollGallery(direction) {
      const gallery = document.querySelector('.gallery');
      const moveBy = gallery.clientWidth * 0.8;
      gallery.scrollBy({ left: direction * moveBy, behavior: 'smooth' });
    }

    function checkScrollPosition() {
      const g = document.querySelector('.gallery');
      document.getElementById('left-scroll').style.visibility =
        g.scrollLeft <= 5 ? 'hidden' : 'visible';
      document.getElementById('right-scroll').style.visibility =
        g.scrollLeft + g.clientWidth >= g.scrollWidth - 5 ? 'hidden' : 'visible';
    }

		window.addEventListener('load', () => {
			// Galerie + scroll
			const gallery = document.querySelector('.gallery');
			gallery.addEventListener('scroll', checkScrollPosition);
			setTimeout(checkScrollPosition, 100);
			images = collectGalleryImages();

			// Panier visuel
			window.dispatchEvent(new Event("panierMisAJour"));
		});

    function openModal(src, alt) {
      images = collectGalleryImages();
      currentImageIndex = images.findIndex(img =>
        getFilename(img.src) === getFilename(src)
      );
      if (currentImageIndex < 0) currentImageIndex = 0;

      const imgEl = document.getElementById('modalImage');
      const cap   = document.getElementById('modalCaption');
      imgEl.src = src;
      imgEl.alt = alt;
      cap.textContent = alt;
      imgEl.style.transform = 'translateX(0)';

      const modal = document.getElementById('imageModal');
      modal.style.display = 'flex';
      setTimeout(() => modal.classList.add('show'), 10);
    }

    function closeModal() {
      const modal = document.getElementById('imageModal');
      modal.classList.remove('show');
      setTimeout(() => modal.style.display = 'none', 300);
    }

		function navigateImage(direction) {
			if (!images.length || currentImageIndex < 0) return;

			const imgEl = document.getElementById('modalImage');
			const cap   = document.getElementById('modalCaption');

			// calcul des positions de sortie et d‚Äôentr√©e
			const outX = direction > 0 ? '-100%' : '100%';
			const inX  = direction > 0 ? '100%'  : '-100%';

			// slide out
			imgEl.style.transition = 'transform 0.3s ease';
			imgEl.style.transform  = `translateX(${outX})`;

			setTimeout(() => {
				// mise √† jour de l‚Äôindex
				currentImageIndex = (currentImageIndex + direction + images.length) % images.length;

				// pr√©paration de l‚Äôimage entrante hors champ
				imgEl.style.transition = 'none';
				imgEl.style.transform  = `translateX(${inX})`;
				imgEl.src   = images[currentImageIndex].src;
				imgEl.alt   = images[currentImageIndex].alt;
				cap.textContent = images[currentImageIndex].alt;

				// forcer le reflow pour que la transition soit prise en compte
				void imgEl.offsetWidth;

				// slide in
				imgEl.style.transition = 'transform 0.3s ease';
				imgEl.style.transform  = 'translateX(0)';
			}, 300);
		}
		
		async function ajouterAuPanier() {
				const panier = JSON.parse(localStorage.getItem("panier")) || [];

				const stripeProduct = "{{ .Params.stripeProduct }}";
				const priceIdStripe = "{{ .Params.priceIdStripe }}";
				const nom = "{{ .Params.title }}";//document.querySelector("h1")?.textContent.trim() || "";
				const description = "{{ .Params.description }}";//document.querySelector("h3")?.textContent.trim() || "";
				const prix = parseFloat("{{ .Params.price }}");
				const monnaie = "{{ .Params.currency }}";
				const image = "{{ .Params.thumbnail }}".startsWith("http")
						? "{{ .Params.thumbnail }}"
						: `https://encompagniedesetoiles.fr{{ .Params.thumbnail }}`;

				// üîç V√©rification
				if (isNaN(prix) || !monnaie || !nom) {
						console.error("Article invalide ‚Äì v√©rifie les donn√©es !");
						alert("‚ö†Ô∏è Impossible d'ajouter cet article : donn√©es manquantes ou invalides.");
						return;
				}

				const index = panier.findIndex(p => p.nom === nom);
				
				const quantiteDemandee = index >= 0 ? panier[index].quantite + 1 : 1;

				const ok = await verifierQuantiteDisponible(stripeProduct, quantiteDemandee);
				if (!ok) {
					afficherMiniPanier();
					ouvrirPanier();
					return;
				}
				
				if (index >= 0) {
						panier[index].quantite += 1;
				} else {
						panier.push({ nom, description, prix , stripeProduct, priceIdStripe, monnaie, image, quantite: 1 });
				}

				localStorage.setItem("panier", JSON.stringify(panier));
				window.dispatchEvent(new Event("panierMisAJour")); // ‚úÖ d√©clenche la mise √† jour
				
				afficherMiniPanier();
				ouvrirPanier();

		}

		async function verifierQuantiteDisponible(stripeProduct, quantiteDemandee) {
				const panier = JSON.parse(localStorage.getItem("panier")) || [];

				const response = await fetch(`/.netlify/functions/getInventory?product=` + stripeProduct);
				const data = await response.json();
				quantiteDisponible = parseInt(data.inventory, 10);

				// üßæ Log de diagnostic
				console.log(`üì¶ Stock disponible : ${quantiteDisponible}`);
				console.log(`üì• Quantit√© demand√©e : ${quantiteDemandee}`);

				// V√©rifie si la quantit√© demand√©e d√©passe le stock
				if (quantiteDemandee > quantiteDisponible) {
						alert("‚ö†Ô∏è Stock insuffisant : quantit√© demand√©e sup√©rieure au stock disponible.");
						return false;
				}

				return true;
		}


		//R√©cup√©ration du stock sur Stripe
		async function fetchInventoryCurrentProduct() {
				const response = await fetch(`/.netlify/functions/getInventory?product=` + "{{ .Params.stripeProduct }}");
				const data = await response.json();
				stockDisponible = parseInt(data.inventory, 10);
				
				document.getElementById("stock-display").textContent = stockDisponible;
				
				if (stockDisponible <= 0) {
						const bouton = document.querySelector(".btn-add-to-cart");
						if (bouton) {
								bouton.disabled = true;
								bouton.textContent = "Stock √©puis√©";
						}
				}
		}

		fetchInventoryCurrentProduct();
</script>
{{ end }}
